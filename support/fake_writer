#!/usr/bin/env ruby
# frozen_string_literal: true

# rubocop:disable Discourse/Plugins/NamespaceConstants, Discourse/Plugins/NamespaceMethods

# Browser-based shared edit simulator for testing Yjs operational transformation
#
# Usage: fake_writer POST_ID [OPTIONS]
#
# Options:
#   --speed=slow|normal|fast    Typing speed (default: normal)
#   --headless=true|false       Run headless browser (default: true)
#   --user=USERNAME             Login username (default: admin)
#   --base-url=URL              Discourse URL (default: http://localhost:4200)
#
# The shared-edits plugin throttles syncs every 350ms during continuous typing.

rails_root = File.expand_path("../../../..", __FILE__)
ENV["RAILS_ENV"] ||= "development"
# rubocop:disable Discourse/NoChdir
Dir.chdir(rails_root)
require File.expand_path("config/environment", rails_root)

require "playwright"

MARKER = "â–Œ"

PHRASES = [
  "The quick brown fox jumps over the lazy dog. ",
  "Hello world! This is a test. ",
  "Testing shared edits functionality. ",
  "Multiple users can edit simultaneously. ",
  "Real-time synchronization in action! ",
  "Lorem ipsum dolor sit amet. ",
].freeze

# Speed configs
SPEEDS = {
  "slow" => {
    char_ms: 100..200,
    phrase_ms: 800..1500,
  },
  "normal" => {
    char_ms: 30..80,
    phrase_ms: 200..400,
  },
  "fast" => {
    char_ms: 10..30,
    phrase_ms: 50..150,
  },
}.freeze

def parse_args
  opts = { speed: "normal", headless: true, user: "admin", base_url: "http://localhost:4200" }
  post_id = nil

  ARGV.each do |arg|
    case arg
    when /^--speed=(.+)$/
      opts[:speed] = $1
    when /^--headless=(.+)$/
      opts[:headless] = $1 != "false"
    when /^--user=(.+)$/
      opts[:user] = $1
    when /^--base-url=(.+)$/
      opts[:base_url] = $1
    when /^--post-id=(\d+)$/
      post_id = $1.to_i
    when /^\d+$/
      post_id = arg.to_i
    end
  end

  [post_id, opts]
end

def topic_for_post(post_id)
  post = Post.includes(:topic).find_by(id: post_id)
  unless post
    warn "Post #{post_id} not found"
    exit 1
  end

  topic = post.topic
  unless topic
    warn "Topic for post #{post_id} not found"
    exit 1
  end

  { id: topic.id, slug: topic.slug, title: topic.title }
end

def type_char(page, char, marker)
  input = page.query_selector("#reply-control .d-editor-input")
  return false unless input

  content = input.evaluate("el => el.value")
  pos = content.index(marker)
  return false unless pos

  input.focus
  page.evaluate(
    "(pos) => { document.querySelector('#reply-control .d-editor-input').setSelectionRange(pos, pos); }",
    arg: pos,
  )
  page.keyboard.insert_text(char)
  true
end

def insert_marker(page, marker)
  input = page.query_selector("#reply-control .d-editor-input")
  return unless input

  content = input.evaluate("el => el.value")
  return if content.include?(marker)

  pos = content.length
  js =
    "(p) => { const el = document.querySelector('#reply-control .d-editor-input'); " \
      "el.value = el.value.slice(0,p) + '#{marker}' + el.value.slice(p); " \
      "el.dispatchEvent(new Event('input', {bubbles:true})); }"
  page.evaluate(js, arg: pos)
  puts "Inserted cursor marker at position #{pos}"
  sleep 0.5
end

# Main
post_id, opts = parse_args

unless post_id
  puts "Usage: fake_writer POST_ID [--speed=slow|normal|fast] [--headless=true|false]"
  exit 1
end

speed = SPEEDS[opts[:speed]] || SPEEDS["normal"]
topic = topic_for_post(post_id)
marker = MARKER

puts "=" * 50
puts "Fake Writer - Shared Edit Simulator"
puts "=" * 50
puts "Post: #{post_id}"
puts "Topic: #{topic[:title]}"
puts "Speed: #{opts[:speed]} (char: #{speed[:char_ms]}ms, phrase: #{speed[:phrase_ms]}ms)"
puts "Headless: #{opts[:headless]}"
puts "=" * 50

Playwright.create(playwright_cli_executable_path: "./node_modules/.bin/playwright") do |playwright|
  browser =
    playwright.chromium.launch(
      headless: opts[:headless],
      args: %w[--no-sandbox --disable-dev-shm-usage --disable-gpu --mute-audio],
    )
  page = browser.new_page

  begin
    # Login
    puts "Logging in as #{opts[:user]}..."
    page.goto("#{opts[:base_url]}/session/#{opts[:user]}/become")
    sleep 2

    # Navigate to topic
    puts "Opening topic..."
    page.goto("#{opts[:base_url]}/t/#{topic[:slug]}/#{topic[:id]}")
    sleep 2

    # Enable shared edits if not already
    unless page.query_selector(".shared-edit")
      puts "Enabling shared edits..."
      page.query_selector(".show-more-actions")&.click
      sleep 0.3
      page.query_selector(".show-post-admin-menu")&.click
      sleep 0.3
      page.query_selector(".admin-toggle-shared-edits")&.click
      sleep 1
    end

    # Open composer
    puts "Opening shared edit composer..."
    page.wait_for_selector(".shared-edit", timeout: 5000).click
    sleep 2
    page.wait_for_selector("#reply-control.open", timeout: 10_000)
    puts "Composer ready"

    # Insert marker if needed
    insert_marker(page, marker)

    puts "-" * 50
    puts "Typing... (Ctrl+C to stop)"
    puts "-" * 50

    # Main typing loop
    idx = 0
    loop do
      phrase = PHRASES[idx % PHRASES.length]
      idx += 1

      phrase.each_char do |char|
        type_char(page, char, marker)
        print char
        $stdout.flush
        sleep(rand(speed[:char_ms]) / 1000.0)
      end

      puts
      sleep(rand(speed[:phrase_ms]) / 1000.0)
    end
  rescue Interrupt
    puts "\n\nStopped by user."
  ensure
    browser.close
  end
end
